name: Publish VS Code Extension

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g. 6.0.0)'
        required: false
        type: string
      publish-ovsx:
        description: 'Also publish to OpenVSX Registry'
        required: false
        type: boolean
        default: false
  release:
    types: [published]

env:
  VSCE_PAT: ${{ secrets.VSCE_PAT }}
  OVSX_PAT: ${{ secrets.OVSX_PAT }}

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    defaults:
      run:
        shell: bash
        working-directory: editor/vscode/nyx-language
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'editor/vscode/nyx-language/package-lock.json'

      - name: Update version
        run: |
          if [[ "${{ github.event_name }}" == "release" ]]; then
            TAG="${{ github.event.release.tag_name }}"
            VERSION="${TAG#v}"
            echo "VERSION=$VERSION" >> $GITHUB_ENV
            npm version "$VERSION" --no-git-tag-version --allow-same-version
          elif [[ -n "${{ github.event.inputs.version }}" ]]; then
            echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_ENV
            npm version "${{ github.event.inputs.version }}" --no-git-tag-version --allow-same-version
          else
            VERSION=$(node -p "require('./package.json').version")
            echo "VERSION=$VERSION" >> $GITHUB_ENV
          fi

      - name: Install dependencies
        run: |
          npm ci
          npm list vsce 2>/dev/null || npm install --save-dev vsce

      - name: Compile TypeScript
        run: npm run compile

      - name: Verify build
        run: |
          if [[ ! -d "out" ]]; then
            echo "âŒ Build failed: output directory not found"
            exit 1
          fi
          echo "âœ… Build verification passed"
          ls -la out/ | head -10

      - name: Prepare assets
        run: |
          echo "ðŸ“¦ Preparing release assets..."
          [ -f "../../../assets/nyx-logo.png" ] && cp ../../../assets/nyx-logo.png . || true
          [ -f "../../../README.md" ] && cp ../../../README.md ./README_REPO.md || true
          [ -f "../../../CHANGELOG.md" ] && cp ../../../CHANGELOG.md ./CHANGELOG_REPO.md || true
          echo "âœ… Assets prepared"

      - name: Create VS Code Extension package
        run: |
          echo "ðŸ“¦ Creating VSIX package v$VERSION..."
          npx vsce package --out "nyx-language-$VERSION.vsix"
          ls -lh *.vsix
          echo "âœ… Package created successfully"

      - name: Publish to VS Code Marketplace
        if: ${{ env.VSCE_PAT != '' }}
        run: |
          echo "ðŸš€ Publishing Nyx Language Support v$VERSION to VS Code Marketplace..."
          npx vsce publish -p "$VSCE_PAT" --packagePath "nyx-language-$VERSION.vsix"
          echo "âœ… Published to VS Code Marketplace"

      - name: Publish to OpenVSX Registry
        if: ${{ (github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && github.event.inputs['publish-ovsx'] == 'true')) && env.OVSX_PAT != '' }}
        run: |
          echo "ðŸš€ Publishing Nyx Language Support v$VERSION to OpenVSX Registry..."
          npx ovsx publish "nyx-language-$VERSION.vsix" -p "$OVSX_PAT"
          echo "âœ… Published to OpenVSX Registry"
        continue-on-error: true

      - name: Create release metadata
        if: ${{ github.event_name == 'release' }}
        run: |
          echo "ðŸ“‹ Creating release metadata..."
          sha256sum *.vsix > SHA256SUMS
          cat SHA256SUMS
          echo ""
          echo "=== Release Information ===" > release_info.txt
          echo "Extension: Nyx Language Support" >> release_info.txt
          echo "Version: $VERSION" >> release_info.txt
          echo "Release Date: $(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> release_info.txt
          echo "Platforms: VS Code Marketplace, OpenVSX Registry" >> release_info.txt
          cat release_info.txt

      - name: Upload artifacts to GitHub Release
        if: ${{ github.event_name == 'release' }}
        uses: softprops/action-gh-release@v2
        with:
          files: |
            nyx-language-*.vsix
            SHA256SUMS
            release_info.txt
          fail_on_unmatched_files: false
          draft: false
          prerelease: ${{ contains(github.event.release.tag_name, 'alpha') || contains(github.event.release.tag_name, 'beta') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Workflow summary
        if: always()
        run: |
          echo "## ðŸ“Š Publishing Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Extension | Nyx Language Support |" >> $GITHUB_STEP_SUMMARY
          echo "| Version | $VERSION |" >> $GITHUB_STEP_SUMMARY
          echo "| Trigger | ${{ github.event_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Timestamp | $(date -u +'%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
